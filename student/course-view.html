<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning | Success Academy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Unified Video + Description Card */
        .learning-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: var(--transition-smooth);
        }

        .learning-card:hover {
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
        }

        /* Video Player */
        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            cursor: pointer;
        }

        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* Video Controls — visible on hover (desktop) & tap (mobile) */
        .custom-controls {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85), transparent);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 40px 16px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-container:hover .custom-controls,
        .video-container.controls-visible .custom-controls {
            opacity: 1;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .progress-filled {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s linear;
        }

        .speed-select {
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            padding: 2px 5px;
            font-size: 0.8rem;
        }

        .speed-select option {
            background: #1a1a2e;
            color: #fff;
        }

        /* Notes section scroll */
        .notes-scroll {
            flex: 1 1 auto;
            overflow-y: auto;
            padding-right: 8px;
            min-height: 200px;
        }

        .notes-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .notes-scroll::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 10px;
        }

        /* Note items */
        .note-item {
            background: rgba(108, 76, 214, 0.04);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: var(--transition-smooth);
        }

        .note-item:hover {
            border-color: var(--primary);
            background: rgba(108, 76, 214, 0.08);
        }

        .note-timestamp {
            background: var(--primary);
            color: #fff;
            padding: 2px 10px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .note-timestamp:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
        }

        /* Notes panel — fixed height on desktop for side-by-side alignment */
        .notes-panel {
            height: auto;
        }

        /* ===== DESKTOP (lg+): 50/50 side-by-side ===== */
        @media (min-width: 992px) {
            .notes-panel {
                height: calc(100vh - 140px);
                display: flex;
                flex-direction: column;
            }

            .notes-scroll {
                flex: 1 1 0;
                min-height: 0;
            }
        }

        /* ===== MOBILE (below lg): stacked layout ===== */
        @media (max-width: 991.98px) {
            .notes-scroll {
                max-height: 50vh;
            }

            .custom-controls {
                padding: 20px 12px 12px;
            }
        }

        /* ===== SMALL MOBILE ===== */
        @media (max-width: 575.98px) {
            .learning-card .p-4 {
                padding: 1rem !important;
            }

            .glass-card {
                padding: 1rem !important;
            }
        }
    </style>
</head>

<body>
    <div class="mesh-bg"></div>

    <!-- Navbar: Title centered, Exit button on the right -->
    <nav class="navbar py-2 py-lg-3 sticky-top">
        <div class="container-fluid px-3 px-lg-5 d-flex align-items-center justify-content-center position-relative">
            <span class="academy-logo fs-6 fs-lg-5 text-truncate" id="courseTitle"
                style="max-width: 60%;">Loading...</span>
            <a href="dashboard.html"
                class="btn btn-outline-custom rounded-pill btn-sm position-absolute end-0 me-3 me-lg-5">
                <span class="d-none d-sm-inline">Exit Course</span>
                <i class="fas fa-sign-out-alt ms-0 ms-sm-2"></i>
            </a>
        </div>
    </nav>

    <main class="container-fluid px-3 px-lg-5 py-3 py-lg-4">
        <div class="row g-3 g-lg-4">

            <!-- LEFT: Unified Video + Course Info -->
            <div class="col-lg-6 col-12">
                <div class="learning-card animate-slide-up">
                    <!-- Video Player -->
                    <div class="video-container" id="videoWrapper">
                        <div id="player"></div>
                        <div class="custom-controls">
                            <div class="progress-bar-container" id="progressContainer">
                                <div class="progress-filled" id="progressFilled"></div>
                            </div>
                            <div class="d-flex align-items-center gap-2 gap-lg-3">
                                <button id="playPauseBtn" class="btn text-white p-0 fs-5 fs-lg-4">
                                    <i class="fas fa-play" id="playIcon"></i>
                                </button>
                                <span class="text-white small" id="timeDisplay" style="font-size: 0.75rem;">00:00 /
                                    00:00</span>
                                <div class="ms-auto d-flex align-items-center gap-2">
                                    <span class="small text-white-50 d-none d-sm-inline"
                                        style="font-size: 0.7rem;">Speed</span>
                                    <select class="speed-select" id="speedSelect">
                                        <option value="0.5">0.5x</option>
                                        <option value="1" selected>1x</option>
                                        <option value="1.5">1.5x</option>
                                        <option value="2">2x</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Course Description (merged into the same card) -->
                    <div class="p-4">
                        <h5 class="fw-bold mb-2">
                            <i class="fas fa-info-circle text-primary me-2"></i> About this Course
                        </h5>
                        <p id="courseDesc" class="text-muted small mb-3"></p>
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <span class="badge-soft-primary" id="courseInstructor">Instructor</span>
                            <span class="text-muted" style="font-size: 0.7rem;">Success Academy Curriculum</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Study Notes -->
            <div class="col-lg-6 col-12">
                <div class="notes-panel glass-card d-flex flex-column animate-slide-up">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold m-0">
                            <i class="fas fa-edit text-primary me-2"></i> Study Notes
                        </h5>
                        <button class="btn btn-sm btn-outline-custom border-0 text-primary" onclick="downloadNotesPDF()"
                            title="Download PDF">
                            <i class="fas fa-file-pdf fa-lg"></i>
                        </button>
                    </div>

                    <!-- Note Input -->
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" id="noteInput" class="form-control"
                                placeholder="Add a timestamped note...">
                            <button class="btn btn-premium px-3" onclick="addNote()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Notes List -->
                    <div class="notes-scroll" id="notesList">
                        <!-- Notes will appear here -->
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Scripts -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let player;
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = parseInt(urlParams.get('id'));
        const course = DataManager.getCourses().find(c => c.id === courseId);

        if (!course) window.location.href = 'dashboard.html';

        document.getElementById('courseTitle').textContent = course.title;
        document.getElementById('courseDesc').textContent = course.description;
        document.getElementById('courseInstructor').textContent = course.instructor;

        // Toggle video controls on tap (for touch devices)
        document.getElementById('videoWrapper').addEventListener('click', function (e) {
            // Don't toggle if clicking a control element
            if (e.target.closest('.custom-controls')) return;
            this.classList.toggle('controls-visible');
        });

        // YT API
        function onYouTubeIframeAPIReady() {
            const videoId = course.videoUrl.split('/').pop().split('?')[0];
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: videoId,
                playerVars: { 'controls': 0, 'disablekb': 1, 'rel': 0, 'modestbranding': 1, 'fs': 0 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerReady() {
            const progress = DataManager.getProgress(Auth.getUser().email, courseId);
            if (progress && progress.time > 0) {
                player.seekTo(progress.time);
            }
            setInterval(updateTime, 1000);
            setInterval(saveCurrentProgress, 5000);
            loadNotes();
        }

        function saveCurrentProgress() {
            if (player && player.getDuration) {
                const cur = player.getCurrentTime();
                const dur = player.getDuration();
                const perc = Math.round((cur / dur) * 100);
                if (dur > 0) {
                    DataManager.saveProgress(Auth.getUser().email, courseId, cur, perc);
                }
            }
        }

        function onPlayerStateChange(event) {
            const playIcon = document.getElementById('playIcon');
            playIcon.className = (event.data === YT.PlayerState.PLAYING) ? 'fas fa-pause' : 'fas fa-play';
        }

        function updateTime() {
            if (player && player.getDuration) {
                const cur = player.getCurrentTime();
                const dur = player.getDuration();
                document.getElementById('progressFilled').style.width = `${(cur / dur) * 100}%`;
                document.getElementById('timeDisplay').textContent = `${formatTime(cur)} / ${formatTime(dur)}`;
            }
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        // Notes Logic
        function addNote() {
            const text = document.getElementById('noteInput').value;
            if (!text) return;
            const time = player.getCurrentTime();
            const notes = getNotes();
            notes.push({ time, text, date: new Date().toLocaleDateString() });
            saveNotes(notes);
            renderNotes();
            document.getElementById('noteInput').value = '';
        }

        function getNotes() {
            const key = `notes_${courseId}_${Auth.getUser().email}`;
            return JSON.parse(localStorage.getItem(key)) || [];
        }

        function saveNotes(notes) {
            const key = `notes_${courseId}_${Auth.getUser().email}`;
            localStorage.setItem(key, JSON.stringify(notes));
        }

        function renderNotes() {
            const list = document.getElementById('notesList');
            const notes = getNotes().sort((a, b) => a.time - b.time);
            list.innerHTML = notes.length ? '' :
                '<div class="text-center py-5"><i class="fas fa-sticky-note text-muted mb-3" style="font-size: 2rem; opacity: 0.3;"></i><p class="text-muted small">No notes yet. Add one while watching!</p></div>';

            notes.forEach((n, idx) => {
                const div = document.createElement('div');
                div.className = 'note-item';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="note-timestamp" onclick="seekVideo(${n.time})">${formatTime(n.time)}</span>
                        <button class="btn btn-sm text-danger p-0 border-0" onclick="deleteNote(${idx})"><i class="fas fa-trash-alt small"></i></button>
                    </div>
                    <div class="small">${n.text}</div>
                `;
                list.appendChild(div);
            });
        }

        function seekVideo(time) { player.seekTo(time); player.playVideo(); }

        function deleteNote(idx) {
            const notes = getNotes().sort((a, b) => a.time - b.time);
            notes.splice(idx, 1);
            saveNotes(notes);
            renderNotes();
        }

        function loadNotes() { renderNotes(); }

        // PDF Export
        function downloadNotesPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const notes = getNotes().sort((a, b) => a.time - b.time);

            doc.setFontSize(22);
            doc.text("Study Notes: Success Academy", 20, 20);
            doc.setFontSize(14);
            doc.text(`Course: ${course.title}`, 20, 30);
            doc.text(`Student: ${Auth.getUser().name}`, 20, 37);
            doc.line(20, 42, 190, 42);

            let y = 55;
            notes.forEach(n => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Timestamp: ${formatTime(n.time)}`, 20, y);
                doc.setTextColor(0);
                doc.setFontSize(12);
                doc.text(doc.splitTextToSize(n.text, 160), 20, y + 7);
                y += 25;
            });

            doc.save(`${course.title}_Notes.pdf`);
        }

        // UI Controls
        document.getElementById('playPauseBtn').addEventListener('click', () => {
            if (player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo();
            else player.playVideo();
        });

        document.getElementById('speedSelect').addEventListener('change', (e) => player.setPlaybackRate(parseFloat(e.target.value)));

        document.getElementById('progressContainer').addEventListener('click', (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            player.seekTo(pos * player.getDuration());
        });

        document.addEventListener('DOMContentLoaded', () => Auth.checkAuth('student'));
    </script>
</body>

</html>